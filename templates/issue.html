<!DOCTYPE html>
<html lang="en">
<head>
    <title>Track Issue | AVIN Delhi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --canvas: #ffffff;
            --panel: #fcfcfc;
            --stroke: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --accent: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 8px;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--canvas);
            color: var(--text-main);
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 60px 40px; }

        .header-unit { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px; border-bottom: 1.5px solid var(--stroke); padding-bottom: 24px; }
        .header-unit h2 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -1px; }

        .btn-back { text-decoration: none; color: var(--text-muted); font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-back:hover { color: var(--text-main); transform: translateX(-4px); }

        .surface { background: white; border: 1.5px solid var(--stroke); border-radius: var(--radius); overflow: hidden; margin-bottom: 24px; }
        .surface-head { background: var(--panel); padding: 12px 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; border-bottom: 1.5px solid var(--stroke); color: var(--text-muted); letter-spacing: 0.05em; }
        .surface-body { padding: 24px; }

        .timeline { display: flex; justify-content: space-between; position: relative; padding: 20px 0; }
        .timeline::before { content: ""; position: absolute; top: 38px; left: 0; right: 0; height: 2px; background: var(--stroke); }
        #progressBar { position: absolute; top: 38px; left: 0; height: 2px; background: var(--accent); transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .step { position: relative; z-index: 2; text-align: center; width: 100px; }
        .node { width: 12px; height: 12px; background: white; border: 2px solid var(--stroke); border-radius: 2px; margin: 0 auto 12px; transition: 0.3s; }
        .active .node { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.1); }
        .active .step-label { color: var(--text-main); font-weight: 800; }
        .step-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }

        .grid-system { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }

        .data-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--stroke); }
        .data-row:last-child { border-bottom: none; }
        .data-label { font-size: 12px; font-weight: 700; color: var(--text-muted); }
        .data-val { font-family: var(--font-mono); font-size: 13px; font-weight: 700; }

        .status-hero { text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 180px; background: var(--panel); }
        .eta-val { font-family: var(--font-mono); font-size: 48px; font-weight: 800; color: var(--warning); margin: 0; }
        
        .resolved-badge { display: none; }
        .is-resolved .eta-display { display: none; }
        .is-resolved .resolved-badge { display: flex; flex-direction: column; align-items: center; gap: 12px; animation: scaleIn 0.5s ease forwards; }

        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .workflow { list-style: none; padding: 0; margin: 0; }
        .workflow li { padding: 12px 16px; background: var(--panel); border: 1px solid var(--stroke); border-radius: 4px; margin-bottom: 8px; font-size: 13px; display: flex; align-items: center; gap: 12px; }
        .workflow li::before { content: "â†’"; font-family: var(--font-mono); font-weight: 800; color: var(--accent); }

        .legal-box { background: #0f172a; border-color: #1e293b; color: white; }
        #rewriteBox { font-family: var(--font-mono); font-size: 12px; color: #94a3b8; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 4px; overflow-x: auto; margin-top: 24px; border: 1px solid #334155; line-height: 1.6; white-space: pre-wrap; }
        
        .btn-cmd { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 4px; font-weight: 800; font-size: 12px; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-cmd:hover { background: #1d4ed8; }
        .btn-email { background: var(--success); display: none; }

        @media (max-width: 850px) { .grid-system { grid-template-columns: 1fr; } .span-2, .span-3 { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-unit">
        <div>
            <h2>Issue Telemetry</h2>
            <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-muted);">Sector Registry: Analysis & Governance</p>
        </div>
        <a href="/" class="btn-back">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5m0 0l7-7m-7 7l7 7"/></svg>
            BACK_TO_CONSOLE
        </a>
    </div>

    <div class="surface">
        <div class="surface-head">System Status Tracking</div>
        <div class="surface-body">
            <div class="timeline">
                <div id="progressBar" style="width: 5%;"></div>
                <div class="step" id="step-SUBMITTED"><div class="node"></div><div class="step-label">Submitted</div></div>
                <div class="step" id="step-INSPECTED"><div class="node"></div><div class="step-label">Inspected</div></div>
                <div class="step" id="step-IN_PROGRESS"><div class="node"></div><div class="step-label">Processing</div></div>
                <div class="step" id="step-RESOLVED"><div class="node"></div><div class="step-label">Resolved</div></div>
            </div>
        </div>
    </div>

    <div class="grid-system" id="trackerGrid">
        <div class="surface span-2">
            <div class="surface-head">Intelligence Report</div>
            <div class="surface-body">
                <div class="data-row"><span class="data-label">REFERENCE_ID</span><span class="data-val" id="ref-id">#{{ issue_id }}</span></div>
                <div class="data-row"><span class="data-label">SECTOR_LOC</span><span class="data-val" id="ref-loc">...</span></div>
                <div class="data-row"><span class="data-label">CLASSIFICATION</span><span class="data-val" id="ref-cat">...</span></div>
                <div class="data-row"><span class="data-label">RISK_LEVEL</span><span class="data-val" id="ref-sev">...</span></div>
            </div>
        </div>

        <div class="surface status-hero" id="heroCard">
            <div class="eta-display">
                <span style="font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Est_Resolution</span>
                <h1 class="eta-val" id="eta-val">--</h1>
                <span style="font-size: 10px; font-weight: 700; color: var(--text-muted);">DAYS_REMAINING</span>
            </div>
            <div class="resolved-badge">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2.5">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke-linecap="round"></path>
                    <polyline points="22 4 12 14.01 9 11.01" stroke-linecap="round"></polyline>
                </svg>
                <div style="font-weight: 800; font-size: 16px;">RESOLVED_SUCCESS</div>
            </div>
        </div>

        <div class="surface span-2">
            <div class="surface-head">AI Resolution Pathway</div>
            <div class="surface-body">
                <ul class="workflow" id="workflow-list">
                    <li>Initializing resolution sequence...</li>
                </ul>
            </div>
        </div>

        <div class="surface">
            <div class="surface-head">Authorized Portals</div>
            <div class="surface-body" id="linksBox" style="display: flex; flex-direction: column; gap: 8px;">
            </div>
        </div>

        <div class="surface legal-box span-3" id="legalCard">
            <div class="surface-head" style="background: rgba(255,255,255,0.05); color: #94a3b8; border-color: #334155;">SLA Escalation Terminal</div>
            <div class="surface-body">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <b style="font-size: 16px;">LEGAL_DRAFT_GEN</b>
                        <p style="margin: 6px 0 0 0; font-size: 13px; color: #94a3b8;">Automated high-authority escalation for sector SLA breaches.</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-cmd" id="genBtn" onclick="rewrite()">GENERATE_LEGAL_LOG</button>
                        <button class="btn-cmd btn-email" id="emailBtn" onclick="sendEmail()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                            INITIALIZE_DIRECT_EMAIL
                        </button>
                    </div>
                </div>
                <pre id="rewriteBox">SYSTEM_WAITING: Analysis of SLA required. Initialize generation to proceed...</pre>
            </div>
        </div>
    </div>
</div>

<script>
const issueId = {{ issue_id }};
let currentIssueData = null;

// Verified Departmental Email Registry
const OFFICIAL_LINKS = {
    "waste": [
        {name:"MCD Portal", url:"https://mcdonline.nic.in/portal", email:"mcd-ithelpdesk@mcd.nic.in"}
    ],
    "water": [
        {name:"Delhi Jal Board", url:"https://djb.gov.in", email:"ee-pms@djb.gov.in"}
    ],
    "roads": [
        {name:"PWD Delhi", url:"https://pwd.delhi.gov.in", email:"delhipwd@gmail.com"}
    ],
    "air": [
        {name:"DPCC Control", url:"https://dpcc.delhigovt.nic.in", email:"msdpcc@nic.in"}
    ],
    "public infrastructure": [
        {name:"MCD Services", url:"https://mcdonline.nic.in/portal", email:"mcd-ithelpdesk@mcd.nic.in"}
    ],
    "greenery": [
        {name:"Parks & Gardens", url:"https://delhiparksandgardens.org", email:"delhiparks@delhi.gov.in"}
    ],
    "transport": [
        {name:"Traffic Police", url:"https://delhitrafficpolice.nic.in", email:"info@delhitrafficpolice.nic.in"}
    ]
};

async function loadIssue(){
    const res = await fetch(`/api/issue/${issueId}`);
    currentIssueData = await res.json();
    
    document.getElementById("ref-loc").innerText = currentIssueData.location;
    document.getElementById("ref-cat").innerText = currentIssueData.category;
    document.getElementById("ref-sev").innerText = currentIssueData.severity || "STANDARD";
    
    if(currentIssueData.status === "RESOLVED") {
        document.getElementById("trackerGrid").classList.add("is-resolved");
        document.getElementById("legalCard").style.display = "none";
    }

    updateProgressBar(currentIssueData.status);
    renderLinks(currentIssueData.category);
    await loadPrediction();
}

function renderLinks(category){
    const box = document.getElementById("linksBox");
    const links = OFFICIAL_LINKS[(category || "").toLowerCase()] || [];
    box.innerHTML = links.map(l => `
        <a href="${l.url}" target="_blank" style="text-decoration:none; color:var(--accent); font-size:12px; font-weight:800; padding:10px; background:var(--accent-soft); border-radius:4px; text-align:center;">
            ${l.name}
        </a>
        <div style="font-size:10px; color:var(--text-muted); text-align:center; margin-top:-4px; font-family:var(--font-mono)">
            ${l.email}
        </div>
    `).join("");
}

async function rewrite(){
    const btn = document.getElementById('genBtn');
    btn.innerText = "PROCESSING...";
    const res = await fetch(`/api/issue/${issueId}/rewrite`);
    const data = await res.json();
    document.getElementById("rewriteBox").innerText = data.rewritten_complaint;
    btn.innerText = "REGENERATE_LEGAL_LOG";
    // Show email button after generation
    document.getElementById('emailBtn').style.display = 'inline-flex';
}

function sendEmail() {
    const category = currentIssueData.category.toLowerCase();
    const department = OFFICIAL_LINKS[category] ? OFFICIAL_LINKS[category][0] : null;
    
    if (!department) {
        alert("Target authority email not found in registry.");
        return;
    }

    const recipient = department.email;
    const subject = `URGENT: SLA Breach Notification - Issue Ref #${issueId} [${currentIssueData.location}]`;
    const body = document.getElementById("rewriteBox").innerText;

    // Construct Mailto URI
    const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    // Redirect to system mail client
    window.location.href = mailtoLink;
}

// Support functions (Timeline & Prediction)
function updateProgressBar(status) {
    const stages = ["SUBMITTED", "INSPECTED", "IN_PROGRESS", "RESOLVED"];
    const progressMap = { "SUBMITTED": 12.5, "INSPECTED": 37.5, "IN_PROGRESS": 62.5, "RESOLVED": 100 };
    const currentIndex = stages.indexOf(status);
    document.getElementById("progressBar").style.width = (progressMap[status] || 5) + "%";
    stages.forEach((stage, idx) => {
        const el = document.getElementById(`step-${stage}`);
        if(el && idx <= currentIndex) el.classList.add("active");
    });
}

async function loadPrediction(){
    const res = await fetch(`/api/issue/${issueId}/prediction`);
    const data = await res.json();
    document.getElementById("eta-val").innerText = data.estimated_days_max;
    const list = document.getElementById("workflow-list");
    list.innerHTML = data.process.map(step => `<li>${step}</li>`).join("");
}

loadIssue();
</script>
</body>
</html>